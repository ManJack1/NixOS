# ============================================
# 终端和颜色设置
# ============================================
# NOTE: macOS 安装 tmux-256color 参考:
# https://gist.github.com/bbqtd/a4ac060d6f6b9ea6fe3aabe735aa9d95

# 设置默认终端类型为 tmux-256color (支持真彩色)
set-option default-terminal "tmux-256color"

# 启用 RGB 真彩色支持
set-option -a terminal-overrides ",*256col*:RGB"

# 设置默认 shell 为 zsh
set-option -g default-shell "/etc/profiles/per-user/manjack/bin/zsh"

# ============================================
# 前缀键设置
# ============================================
# 将前缀键从默认的 Ctrl-b 改为 Ctrl-a
set -g prefix C-a

# 解绑默认的 Ctrl-b 前缀键
unbind C-b

# 按两次 Ctrl-a 可以发送 Ctrl-a 到终端程序
bind C-a send-prefix

# ============================================
# Tokyo Night 主题设置
# ============================================
# 隐藏日期时间显示
set -g @tokyo-night-tmux_show_datetime 0

# 状态栏位置
set-option -g status-position bottom

# 窗口 ID 样式
set -g @tokyo-night-tmux_window_id_style digital

# 面板 ID 样式
set -g @tokyo-night-tmux_pane_id_style hsquare

# 缩放 ID 样式
set -g @tokyo-night-tmux_zoom_id_style dsquare

# 显示音乐信息
set -g @tokyo-night-tmux_show_music 1

# 显示路径
set -g @tokyo-night-tmux_show_path 1

# 路径格式 (relative 或 full)
set -g @tokyo-night-tmux_path_format relative

# 显示电池信息
set -g @tokyo-night-tmux_show_battery_widget 1
set -g @tokyo-night-tmux_battery_name "BAT1"
set -g @tokyo-night-tmux_battery_low_threshold 21

# ============================================
# 基础设置
# ============================================
# 启用鼠标支持
set -g mouse on

# 窗口编号从 1 开始 (而不是 0)
set -g base-index 1

# 面板编号从 1 开始
setw -g pane-base-index 1

# 增加滚动缓冲区大小
set -g history-limit 50000

# 增加消息显示时间 (毫秒)
set -g display-time 4000

# 设置状态栏刷新频率 (秒)
set -g status-interval 5

# 设置状态栏键绑定为 Emacs 模式
set -g status-keys emacs

# 启用焦点事件支持 (让 Vim 等编辑器知道窗口焦点变化)
set -g focus-events on

# 适用于分组会话和多显示器设置
setw -g aggressive-resize on

# ============================================
# URL 和链接点击支持
# ============================================
# 允许在 tmux 中使用 Ctrl 修饰键点击
set -g mouse on

# 启用剪贴板集成
set -g set-clipboard on

# 允许终端程序处理鼠标事件
set -ga terminal-overrides ',*:Tc'
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'

# ============================================
# 插件配置
# ============================================
# 安装 TPM (Tmux Plugin Manager)
set -g @plugin 'tmux-plugins/tpm'

# tmux-sensible: 合理的默认设置
set -g @plugin 'tmux-plugins/tmux-sensible'

# Tokyo Night 主题
set -g @plugin "janoamaral/tokyo-night-tmux"

# Tmux Yank: 改进的复制功能 (支持系统剪贴板)
set -g @plugin 'tmux-plugins/tmux-yank'

# ============================================
# 窗口和面板快捷键
# ============================================
# 快速切换窗口
bind C-p previous-window
bind C-n next-window

# 重新加载 tmux 配置文件
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# 创建新窗口
bind -n M-w new-window

# 垂直分割窗口 (左右)
bind -n M-v split-window -h

# 水平分割窗口 (上下)
bind -n M-c split-window -v

# 切换到上一个/下一个窗口
bind -n M-, previous-window
bind -n M-. next-window

# 使用 Alt + 数字键切换到特定窗口
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# ============================================
# 面板调整快捷键
# ============================================
# 使用 Alt + hjkl 调整面板大小
bind -n M-h resize-pane -L 5
bind -n M-k resize-pane -U 5
bind -n M-l resize-pane -R 5
bind -n M-j resize-pane -D 5

# 关闭当前面板 (无确认提示)
bind -n M-q kill-pane

# 重新加载配置文件 (大写 R)
bind R source-file '~/.tmux.conf'

# ============================================
# Vim-Tmux 导航集成
# ============================================
# 检测当前面板是否运行 Vim/Neovim
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^(.*\s)?(vi|vim|nvim|view|less|nano)(\s.*)?$'"

# 使用 Ctrl + hjkl 在 Vim 和 Tmux 面板间无缝切换
bind -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"

# ============================================
# 初始化 TPM (必须放在文件最后)
# ============================================
run '/home/manjack/.dotfiles/config/tmux/plugins/tpm/tpm'
